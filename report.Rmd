---
title: "BDA - Project report"
author: "Anonymous"
output: 
  pdf_document: 
    toc: yes
    toc_depth: 3
urlcolor: blue
---

```{r, include=FALSE}
library(rstan)
library(ggplot2)
library(posterior)
library(loo)
library(patchwork)
library(dplyr)
library(reshape2)
library(scales)
```

First, let us import the data into its own dataframe:

```{r}
burnout <- read.csv('data/burnout.csv')
head(burnout)
```
```{r}
ggplot() + 
  geom_point(data=burnout, aes(x=fatigue_score, y=burn_rate, col=sex, alpha=0.5))
```


Let's do a bit of data analysis:

```{r, fig.width=14, fig.height=5}
df_plot <- as.data.frame(table(burnout$sex))
df_plot$Freq <- df_plot$Freq / sum(df_plot$Freq)

sex_percent <- ggplot(data=df_plot, aes(x="", y=Freq, fill=Var1))+
  geom_bar(stat='identity', width=0.5) + 
  labs(title='Percentage of Female vs Male') + 
  guides(fill=guide_legend(title='Sex')) + 
  scale_y_continuous(labels = scales::percent) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank())

df_plot <- as.data.frame(table(burnout$company_type))
df_plot$Freq <- df_plot$Freq / sum(df_plot$Freq)

company_percent <- ggplot(data=df_plot, aes(x="", y=Freq, fill=Var1))+
  geom_bar(stat='identity', width=0.5) + 
  labs(title='Percentage of Product vs Service company') +
  guides(fill=guide_legend(title='Company type')) + 
  scale_y_continuous(labels = scales::percent) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank())

df_plot <- as.data.frame(table(burnout$wfh))
df_plot$Freq <- df_plot$Freq / sum(df_plot$Freq)

wfh_percent <- ggplot(data=df_plot, aes(x="", y=Freq, fill=Var1))+
  geom_bar(stat='identity', width=0.5) + 
  labs(title='Percentage of Cannot work remotely vs Can work remotely') +
  guides(fill=guide_legend(title='Work from home set up')) + 
  scale_y_continuous(labels = scales::percent) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank())


sex_percent + company_percent + wfh_percent
```

```{r}
df_cor <- data.frame(burnout$designation, burnout$work_hours, burnout$fatigue_score)
names(df_cor) <- gsub("burnout.", "", names(df_cor))
df_cor <- round(cor(df_cor), 2)
df_cor <- melt(df_cor)
ggplot(data=df_cor, aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile() + 
  geom_text(aes(Var2, Var1, label = value),
          color = "white", size = 4)
```
Most of the correlations are very high, so if we use all of them, we will have the problem of multicolinearity


A bit of converting Male and Female to binary index (1 and 2)
```{r}
burnout$sex[burnout$sex == 'Male'] <- 1
burnout$sex[burnout$sex == 'Female'] <- 2
```

```{r}
stan_data <- list(
  N = nrow(burnout),
  J = 2,
  id = as.numeric(burnout$sex),
  x = burnout$fatigue_score,
  y = burnout$burn_rate
)
```

For testing,   mu0 ~ normal(0, 500); sigma0 ~ gamma(10, 10); mu1 ~ normal(0.5, 100); sigma1 ~ gamma(10, 10); sigma ~ gamma(80, 10);

```{r}
hie_sm <- stan(file='stan_model/linear_hierachical.stan', iter=3000, data=stan_data, refresh=0)
```

```{r}
draws_hie <- rstan::extract(hie_sm)

plot <- ggplot() + 
  geom_point(data=burnout, aes(x=fatigue_score, y=burn_rate, col=sex))

hex_code <- hue_pal()(2)

for (i in 1:2) {
  beta0 <- quantile(draws_hie$beta0[,i], c(0.5))[['50%']]
  beta1 <- quantile(draws_hie$beta1[,i], c(0.5))[['50%']]
  df_plot <- as.data.frame(burnout[burnout$sex==i, ]$fatigue_score)
  colnames(df_plot) <- c('x')
  df_plot$y <- beta0 + df_plot$x*beta1
  plot <- plot + geom_line(data=df_plot, aes(x=x, y=y), col=hex_code[i], size=3)
  
  
  # beta0 <- draws_hie$beta0[,i]
  # beta1 <- draws_hie$beta1[,i]
  # M <- length(beta0)
  # df_plot <- as.data.frame(burnout[burnout$sex==i, ]$fatigue_score)
  # colnames(df_plot) <- c('x')
  # for (m in 1:100) {
  #   df_plot$y <- beta0[m] + df_plot$x*beta1[m]
  #   plot <- plot + geom_line(data=df_plot, aes(x=x, y=y), col=hex_code[i])
  # }
  
}

plot
```

To means for teh effect of covariates. Define index ==1 if it is male and == 0 it is female. Depends on the observation, it will be relay to the correct mean.
In brms there is an option to build a Stan code. Use brms to define problem and auto Stan
